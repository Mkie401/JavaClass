<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Insert title here</title>
		
		<!--  
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		-->
		
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>		
		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>			
		
	</head>
	<body>
		<h1>Chat Room</h1>
		<hr />
		<div>
			Account: <input id="account" /><br />
			Password: <input id="passwd" type="password" /><br />
			<button id="login">Login</button>
		</div>
		<p>登入狀態: <span id="status">未登入</span></p>
		
		<div id="chatArea" style="display:none;">
			<div id="chatBox" 
				style="border: 1px solid #ccc; width:480px; height:300px; overflow-y:scroll;"></div>
			<input id="mesg" style="width: 400px;"/>
			<button id="send">Send</button>
		</div>
		
	</body>
	<script>
		let token = null;
		let client = null
		document.getElementById("login").onclick = async () => {
			let account = document.getElementById("account").value;
			let passwd = document.getElementById("passwd").value;
			
			let resp = await fetch("/auth/login", {
				method: "POST",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify({
					"account": account,
					"passwd" : passwd
				})
			});
			
			console.log(resp);
			
			let data = await resp.json();
			token = data.token;
			document.getElementById("status").innerHTML = '已登入:' + data.account;
			document.getElementById("chatArea").style.display = "block";
			
			connectWebSocket();
		};
		
		function connectWebSocket(){
			let socket = new SockJS('/ws-chat?token=' + encodeURIComponent('Bearer ' + token));
			client = Stomp.over(socket);
			client.connect({}, function(frame){
				console.log(frame);
				client.subscribe("/topic/public",function(message){
					console.log(message);
					let body = JSON.parse(message.body);
					
					receiveMessage(body);
				});
			});
		}
		
		function receiveMessage(mesg){
			let box = document.getElementById("chatBox");
			let line = document.createElement("div");
			line.innerText = `[${mesg.time}] ${mesg.account}: ${mesg.content}`;
			box.appendChild(line);
		}
		
		document.getElementById("send").onclick = () => {
			// url : /app/chat/send
			let input = document.getElementById("mesg"); 
			let mesg = input.value.trim();
		
			client.send('/app/chat/send',{}, mesg);
			input.value = '';
		};
		
		
		
		
	
	</script>
	
	
	
</html>